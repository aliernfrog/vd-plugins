(function(l,r,u,t,N,P,$,z,F){"use strict";const d=r.findByProps("getStickerSendability"),B=d.StickerSendability.SENDABLE??0;function I(){const e=[u.instead("getStickerSendability",d,function(){return B}),u.instead("isSendableSticker",d,function(){return!0})];return function(){return e.forEach(function(n){return n?.()})}}const b=r.findByProps("canUseAnimatedEmojis"),x="canUseStickersEverywhere",A="canUseCustomStickersEverywhere",L=b[A]?A:x;function M(){return u.instead(L,b,function(){return!0})}const{getChannel:U}=r.findByStoreName("ChannelStore"),O="https://media.discordapp.net/stickers/{stickerId}.{format}?size={size}";function V(e,n){if(!e.guild_id)return!0;const a=U(n).guild_id;return e.guild_id==a?e.available:!1}function D(e){const n=e.format_type===4?"gif":"png";return O.replace("{stickerId}",e.id).replace("{format}",n).replace("{size}",t.storage.stickerSize.toString())}async function _(e){try{let n=new FormData;n.append("new-image-url",e);let a=await fetch("https://ezgif.com/apng-to-gif",{method:"POST",body:n});const c=a.url.split("/").pop().replace(/\.html$/,"");return n=new FormData,n.append("file",c),n.append("size",t.storage.stickerSize.toString()),a=await fetch(`https://ezgif.com/apng-to-gif/${c}.html?ajax=true`,{method:"POST",body:n}),`https:${(await a.text()).split('<img src="')[1].split('" style=')[0]}`}catch(n){return P.logger.error(`Failed to convert ${e} to GIF: `,n),null}}const g=new Map;function j(e,n){g.set(e,n),setTimeout(function(){return g.delete(e)},18e5)}function H(e){return g.get(e)}const{openAlert:K}=r.findByProps("openAlert","dismissAlert"),{AlertModal:w,AlertActionButton:m}=r.findByProps("AlertModal","AlertActions"),{Stack:q,TextInput:ue}=r.findByProps("Stack");function E(e){w&&m?J(e):$.showConfirmationAlert(e)}function J({title:e,content:n,placeholder:a,confirmText:c,cancelText:k,onConfirm:S}){K(Q(e),React.createElement(w,{title:e,content:n,actions:React.createElement(q,null,React.createElement(m,{text:c,variant:"primary",onPress:S}),k?React.createElement(m,{text:k,variant:"secondary"}):React.createElement(React.Fragment,null))}))}function Q(e){return`vdarnfg-${e?.toLowerCase?.().replaceAll?.(" ","-")}`}function W(e){E({title:"APNG Sticker",content:`This sticker will be converted to a GIF using Ezgif and an Ezgif link will be sent in chat.
Do you want to continue?`,confirmText:"Continue",cancelText:"Cancel",onConfirm:e})}function X(e){E({title:"APNG conversion failed",content:[(e?"Instead of an animated GIF, raw APNG sticker will be sent in chat":"No stickers will be sent in chat")+", you can customize this behavior in plugin settings.","","Check debug logs for more information about the error."].join(`
`),confirmText:"OK"})}const R=r.findByProps("sendMessage","receiveMessage"),{getStickerById:Y}=r.findByStoreName("StickersStore"),{getCurrentUser:Z}=r.findByStoreName("UserStore");function ee(){return u.instead("sendStickers",R,function(e,n){if(!t.storage.ignoreNitro&&Z?.().premiumType!==null)return n(...e);const[a,c,k,S]=e,h=c.map(function(i){return Y(i)}).filter(function(i){return!V(i,a)});if(!h.length)return n(...e);const G=async function(i){i&&(t.storage.ackedApng=!0);for(const f of h){let o=D(f);if(f.format_type===2&&t.storage.convertApng){let y=H(o);if(!y){N.showToast("Converting APNG sticker to GIF..");const v=await _(o);if(v)j(o,v);else if(X(t.storage.staticApngOnFail),!t.storage.staticApngOnFail)continue;y=v}o=y??o}t.storage.hyperlink&&f.name&&(o=`[${f.name}](${o})`),R.sendMessage(a,{content:o},null,S)}};h.find(function(i){return i.format_type==2})&&!t.storage.ackedApng?W(function(){return G(!0)}):G()})}const{Stack:te,TableRadioGroup:ne,TableRadioRow:re,TableSwitchRow:s,TableRowGroup:T}=r.findByProps("TableRow","TableRowGroup"),{ScrollView:ae}=F.General,oe=r.findByName("HelpMessage"),ie=[16,32,64,128,160,256,512,1024];t.storage.convertApng??=!0,t.storage.hyperlink??=!0,t.storage.stickerSize??=160;function ce(){return z.useProxy(t.storage),React.createElement(ae,{style:{flex:1},contentContainerStyle:{paddingBottom:38}},React.createElement(te,{style:{paddingVertical:24,paddingHorizontal:12},spacing:24},React.createElement(T,{title:"General"},React.createElement(s,{label:"Hyperlink stickers",value:t.storage.hyperlink,onValueChange:function(e){return t.storage.hyperlink=e}}),React.createElement(s,{label:"Ignore Nitro",subLabel:"Force FreeStickers even when you have Nitro",value:t.storage.ignoreNitro,onValueChange:function(e){return t.storage.ignoreNitro=e}})),React.createElement(T,{title:"APNG Stickers"},React.createElement(s,{label:"Convert APNG stickers to GIF",subLabel:"This is needed for stickers to be animated (uses Ezgif).",value:t.storage.convertApng,onValueChange:function(e){return t.storage.convertApng=e}}),React.createElement(s,{label:"Send static sticker if APNG conversion fails",value:t.storage.staticApngOnFail,onValueChange:function(e){return t.storage.staticApngOnFail=e}}),React.createElement(s,{label:"Show warning dialog for APNG stickers",subLabel:"This will only appear once",value:!t.storage.ackedApng,onValueChange:function(e){return t.storage.ackedApng=!e}})),React.createElement(ne,{title:"Stickers Size",value:t.storage.stickerSize.toString(),onChange:function(e){return t.storage.stickerSize=parseInt(e)}},ie.map(function(e){return React.createElement(re,{label:e.toString(),subLabel:e==160?"Default":null,key:e.toString(),value:e.toString()})})),React.createElement(oe,{messageType:0},"Stickers size option does not work consistently at the moment.")))}let p;const se=function(){p&&C(),p=[I(),M(),ee()]},C=function(){return p?.forEach?.(function(e){return e?.()})},le=ce;return l.onLoad=se,l.onUnload=C,l.settings=le,l})({},vendetta.metro,vendetta.patcher,vendetta.plugin,vendetta.ui.toasts,vendetta,vendetta.ui.alerts,vendetta.storage,vendetta.ui.components);
